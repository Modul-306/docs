name: Keep draw.io png synchronized

on:
  push:
    # branches:
    #   - main 
    paths:
      - "**.drawio"
      - .github/workflows/drawio-png-sync.yml

jobs:
  export-drawio:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to push changes back to the repo

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Required for git-auto-commit to work properly

      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      - name: Export .drawio files to .png using Docker
        run: |
          # Pull the official draw.io docker image
          docker pull jgraph/drawio

          # Find and convert all .drawio files to .png
          find . -name "*.drawio" -print0 | while IFS= read -r -d '' file; do
            png_file="${file%.drawio}.png"
            docker run --rm -v "$PWD:/workspace" jgraph/drawio --export --format png --output "/workspace/$png_file" "$file"
          done

      - name: Auto Commit Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: Auto-export draw.io diagrams to PNG"
          file_pattern: "*.png"
          commit_user_name: "github-actions[bot]"