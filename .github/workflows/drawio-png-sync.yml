name: Keep draw.io png synchronized

on:
  push:
    # branches:
    #   - main 
    paths:
      - "**.drawio"
      - .github/workflows/drawio-png-sync.yml

jobs:
  export-drawio:
    runs-on: ubuntu-latest
    permissions:
      contents: write 

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Download draw.io desktop
        run: |
          # Extract version without "v" prefix
          DRAWIO_VERSION=$(curl -s https://api.github.com/repos/jgraph/drawio-desktop/releases/latest | grep -oP '"tag_name": "\Kv?(.*)(?=")' | sed 's/^v//')
          wget https://github.com/jgraph/drawio-desktop/releases/download/v$DRAWIO_VERSION/drawio-amd64-$DRAWIO_VERSION.deb
          sudo dpkg -i drawio-amd64-$DRAWIO_VERSION.deb || sudo apt-get install -f -y

      - name: Export .drawio files to .png
        run: |
          find . -name "*.drawio" -print0 | while IFS= read -r -d '' file; do
            png_file="${file%.drawio}.png"
            drawio --export --format png --output "$png_file" "$file"
          done

      - name: Auto Commit Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: Auto-export draw.io diagrams to PNG"
          file_pattern: "*.png"
          commit_user_name: "github-actions[bot]"